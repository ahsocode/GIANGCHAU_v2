// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  // KHÔNG set output => Prisma Client nằm trong node_modules (mặc định)
}

datasource db {
  provider = "postgresql"
  // Prisma 7: url nằm trong prisma.config.ts
}

////////////////////////////////////////////////////////////
// ENUMS
////////////////////////////////////////////////////////////

enum AccountStatus {
  ACTIVE
  DISABLED
}

enum RoleKey {
  ADMIN
  DIRECTOR
  STAFF
  EMPLOYEE
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum WorkShiftStatus {
  ACTIVE
  ARCHIVED
}

enum ScheduleStatus {
  DRAFT
  PUBLISHED
  LOCKED
}

enum AttendanceSource {
  WEB
  MOBILE
  DEVICE
  IMPORT
  MANUAL
}

enum AttendanceEventType {
  CHECK_IN
  CHECK_OUT
  BREAK_START
  BREAK_END
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EARLY_LEAVE
  LATE_AND_EARLY
  NO_SHIFT
  INCOMPLETE
}

enum OvertimeStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  CANCELLED
}

enum LeaveType {
  ANNUAL
  SICK
  UNPAID
  OTHER
}

enum LeaveStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  CANCELLED
}

enum EmploymentType {
  CT // Chính thức
  TV // Thời vụ
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  RESTORE
  IMPORT
  LOGIN
  LOGOUT
  APPROVE
  REJECT
}

enum AuditEntity {
  ACCOUNT
  EMPLOYEE
  DEPARTMENT
  POSITION
  WORK_SHIFT
  WORK_SCHEDULE
  ATTENDANCE_RECORD
  ATTENDANCE_EVENT
  OVERTIME
  LEAVE
  PAYROLL_PERIOD
  FILE_IMPORT
}

////////////////////////////////////////////////////////////
// CORE AUTH / ACCOUNT
////////////////////////////////////////////////////////////

model Account {
  id           String        @id @default(uuid())
  email        String        @unique
  passwordHash String?
  name         String?
  phone        String?
  status       AccountStatus @default(ACTIVE)
  roleKey      RoleKey       @default(EMPLOYEE)

  // 1-1 optional với Employee
  employeeId String?   @unique
  employee   Employee? @relation(fields: [employeeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Audit logs (actor)
  audits AuditLog[] @relation("audit_actor")

  // ✅ Opposite relation fields (bắt buộc vì ta đặt @relation("...") ở phía kia)
  schedulesCreated WorkSchedule[] @relation("schedule_created_by")
  schedulesUpdated WorkSchedule[] @relation("schedule_updated_by")

  attendanceCreated AttendanceRecord[] @relation("attendance_created_by")
  attendanceUpdated AttendanceRecord[] @relation("attendance_updated_by")

  eventsCreated AttendanceEvent[] @relation("event_created_by")

  overtimeApproved OvertimeRequest[] @relation("ot_approved_by")
  overtimeCreated  OvertimeRequest[] @relation("ot_created_by")
  overtimeUpdated  OvertimeRequest[] @relation("ot_updated_by")

  leaveApproved LeaveRequest[] @relation("leave_approved_by")
  leaveCreated  LeaveRequest[] @relation("leave_created_by")
  leaveUpdated  LeaveRequest[] @relation("leave_updated_by")

  importsCreated FileImport[] @relation("import_created_by")
}

////////////////////////////////////////////////////////////
// HR: EMPLOYEE, DEPARTMENT, POSITION
////////////////////////////////////////////////////////////

model Department {
  id   String @id @default(uuid())
  code String @unique
  name String

  managerId String?
  manager   Employee? @relation("dept_manager", fields: [managerId], references: [id])

  employees Employee[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Position {
  id   String @id @default(uuid())
  code String @unique
  name String

  employees Employee[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Employee {
  id        String    @id @default(uuid())
  code      String    @unique
  fullName  String
  gender    Gender?   @default(OTHER)
  dob       DateTime?
  phone     String?
  personalEmail String?
  address   String?
  avatarUrl String?
  socialInsuranceNumber String? @unique
  citizenIdNumber       String? @unique

  isActive   Boolean   @default(true)
  joinedAt   DateTime?
  resignedAt DateTime?
  employmentType EmploymentType @default(CT)

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  positionId String?
  position   Position? @relation(fields: [positionId], references: [id])

  // account liên kết
  account Account?

  schedules        WorkSchedule[]
  attendance       AttendanceRecord[]
  attendanceEvents AttendanceEvent[]

  overtimeRequests OvertimeRequest[] @relation("ot_employee")
  leaveRequests    LeaveRequest[]    @relation("leave_employee")

  managesDepartments Department[] @relation("dept_manager")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

////////////////////////////////////////////////////////////
// SHIFT & SCHEDULING
////////////////////////////////////////////////////////////

model WorkShift {
  id   String @id @default(uuid())
  code String @unique
  name String

  startTime    String // "08:00"
  endTime      String // "17:00"
  breakMinutes Int    @default(0)

  lateGraceMinutes  Int @default(0)
  earlyGraceMinutes Int @default(0)

  status WorkShiftStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  schedules WorkSchedule[]
}

model PayrollPeriod {
  id        String   @id @default(uuid())
  code      String   @unique // "2025-12"
  startDate DateTime
  endDate   DateTime
  isLocked  Boolean  @default(false)

  schedules WorkSchedule[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WorkSchedule {
  id String @id @default(uuid())

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])

  date DateTime

  workShiftId String?
  workShift   WorkShift? @relation(fields: [workShiftId], references: [id])

  // SNAPSHOT
  plannedName              String
  plannedStart             String
  plannedEnd               String
  plannedBreakMinutes      Int    @default(0)
  plannedLateGraceMinutes  Int    @default(0)
  plannedEarlyGraceMinutes Int    @default(0)

  status ScheduleStatus @default(PUBLISHED)

  payrollPeriodId String?
  payrollPeriod   PayrollPeriod? @relation(fields: [payrollPeriodId], references: [id])

  createdById String?
  createdBy   Account? @relation("schedule_created_by", fields: [createdById], references: [id])

  updatedById String?
  updatedBy   Account? @relation("schedule_updated_by", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ✅ 1 schedule tối đa 1 record
  attendance AttendanceRecord? @relation("schedule_attendance")

  @@unique([employeeId, date])
  @@index([date])
  @@index([employeeId, date])
}

////////////////////////////////////////////////////////////
// ATTENDANCE
////////////////////////////////////////////////////////////

model AttendanceRecord {
  id String @id @default(uuid())

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])

  date       DateTime
  scheduleId String?       @unique
  schedule   WorkSchedule? @relation("schedule_attendance", fields: [scheduleId], references: [id])

  checkInAt  DateTime?
  checkOutAt DateTime?

  workMinutes     Int @default(0)
  breakMinutes    Int @default(0)
  overtimeMinutes Int @default(0)

  lateMinutes       Int @default(0)
  earlyLeaveMinutes Int @default(0)

  status AttendanceStatus @default(INCOMPLETE)
  source AttendanceSource @default(WEB)
  note   String?

  createdById String?
  createdBy   Account? @relation("attendance_created_by", fields: [createdById], references: [id])

  updatedById String?
  updatedBy   Account? @relation("attendance_updated_by", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events AttendanceEvent[]

  @@unique([employeeId, date])
  @@index([date])
  @@index([employeeId, date])
}

model AttendanceEvent {
  id String @id @default(uuid())

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])

  date     DateTime
  recordId String?
  record   AttendanceRecord? @relation(fields: [recordId], references: [id])

  type       AttendanceEventType
  occurredAt DateTime
  source     AttendanceSource    @default(WEB)

  meta Json?

  createdById String?
  createdBy   Account? @relation("event_created_by", fields: [createdById], references: [id])

  createdAt DateTime @default(now())

  // ✅ ép: mỗi ngày 1 CHECK_IN + 1 CHECK_OUT (và 1 BREAK_START/END nếu dùng)
  @@unique([employeeId, date, type])
  @@index([employeeId, date])
  @@index([occurredAt])
}

////////////////////////////////////////////////////////////
// OVERTIME
////////////////////////////////////////////////////////////

model OvertimeRequest {
  id String @id @default(uuid())

  employeeId String
  employee   Employee @relation("ot_employee", fields: [employeeId], references: [id])

  date    DateTime
  startAt DateTime
  endAt   DateTime
  minutes Int      @default(0)

  reason String?
  status OvertimeStatus @default(DRAFT)

  submittedAt  DateTime?
  approvedAt   DateTime?
  approvedById String?
  approvedBy   Account?  @relation("ot_approved_by", fields: [approvedById], references: [id])

  createdById String?
  createdBy   Account? @relation("ot_created_by", fields: [createdById], references: [id])

  updatedById String?
  updatedBy   Account? @relation("ot_updated_by", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId, date])
  @@index([status])
}

////////////////////////////////////////////////////////////
// LEAVE
////////////////////////////////////////////////////////////

model LeaveRequest {
  id String @id @default(uuid())

  employeeId String
  employee   Employee @relation("leave_employee", fields: [employeeId], references: [id])

  type      LeaveType
  startDate DateTime
  endDate   DateTime
  reason    String?
  status    LeaveStatus @default(DRAFT)

  submittedAt  DateTime?
  approvedAt   DateTime?
  approvedById String?
  approvedBy   Account?  @relation("leave_approved_by", fields: [approvedById], references: [id])

  createdById String?
  createdBy   Account? @relation("leave_created_by", fields: [createdById], references: [id])

  updatedById String?
  updatedBy   Account? @relation("leave_updated_by", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId, startDate])
  @@index([status])
}

////////////////////////////////////////////////////////////
// FILE IMPORT
////////////////////////////////////////////////////////////

model FileImport {
  id          String  @id @default(uuid())
  type        String
  fileName    String
  fileUrl     String?
  totalRows   Int     @default(0)
  successRows Int     @default(0)
  failedRows  Int     @default(0)
  errors      Json?

  createdById String?
  createdBy   Account? @relation("import_created_by", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
}

////////////////////////////////////////////////////////////
// AUDIT LOG
////////////////////////////////////////////////////////////

model AuditLog {
  id String @id @default(uuid())

  action   AuditAction
  entity   AuditEntity
  entityId String

  actorId String?
  actor   Account? @relation("audit_actor", fields: [actorId], references: [id])

  before Json?
  after  Json?
  meta   Json?

  createdAt DateTime @default(now())

  @@index([entity, entityId])
  @@index([actorId])
  @@index([createdAt])
}
